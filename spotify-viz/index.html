<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spotify: Emocionalitat i Popularitat</title>

  <!-- Plotly (CDN) -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <!-- PapaParse per llegir CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --border:#e8e8e8; --text:#111; --muted:#555; --bg:#fff; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: var(--text); background: var(--bg); }
    header { padding: 16px 20px; border-bottom: 1px solid var(--border); }
    h1 { font-size: 18px; margin: 0 0 6px; }
    p { margin: 0; color: var(--muted); font-size: 13px; line-height: 1.35; }

    main { padding: 14px 20px 22px; }
    .controls {
      display: flex; gap: 12px; flex-wrap: wrap; align-items: center;
      padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px;
      margin-bottom: 14px;
    }
    label { font-size: 13px; color: #222; display:flex; align-items:center; gap:8px; }
    select, input[type="range"], input[type="number"] { padding: 6px; }
    .small { font-size: 12px; color: #666; }

    .grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 14px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px 6px;
      background: #fff;
    }
    .card h2 { font-size: 14px; margin: 4px 8px 0; }
    .card .desc { margin: 6px 8px 10px; font-size: 12px; color: var(--muted); }

    .plot { width: 100%; height: 420px; }
    #plot_emotional { height: 520px; }

    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
      #plot_emotional { height: 480px; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Spotify: Mapa emocional (valence vs energy)</h1>
    <p>
      Exploració interactiva de la relació entre <b>emocionalitat</b> (valence·energy), <b>popularitat</b> i <b>gèneres</b>.
      Utilitza els filtres per comparar estils i detectar patrons.
    </p>
  </header>

  <main>
    <!-- Controls globals -->
    <div class="controls">
      <label>
        Gènere:
        <select id="genreSelect">
          <option value="__ALL__">Tots</option>
        </select>
      </label>

      <label>
        Popularitat mínima:
        <span id="popVal">40</span>
        <input id="popSlider" type="range" min="0" max="100" value="40" />
      </label>

      <label title="Limita el nombre de gèneres mostrats (Top N per popularitat mitjana)">
        Top gèneres (per popularitat):
        <input id="topGenres" type="number" min="5" max="50" value="15" style="width:70px;" />
      </label>

      <label title="Canvia la variable del gràfic de popularitat">
        Variable:
        <select id="featureSelect">
          <option value="danceability">danceability</option>
          <option value="tempo">tempo</option>
          <option value="valence">valence</option>
          <option value="energy">energy</option>
          <option value="acousticness">acousticness</option>
          <option value="speechiness">speechiness</option>
          <option value="instrumentalness">instrumentalness</option>
          <option value="liveness">liveness</option>
        </select>
      </label>

      <span class="small">Consell: passa el ratolí per veure detalls (tema, artista, gènere, popularitat).</span>
    </div>

    <div class="grid">
      <div class="card">
        <h2>1) Mapa emocional</h2>
        <div class="desc">Cada punt és una cançó. X=valence (positivitat), Y=energy (intensitat), mida≈popularitat, color=gènere.</div>
        <div id="plot_emotional" class="plot"></div>
      </div>

      <div class="card">
        <h2>2) Valence per gènere (Top N)</h2>
        <div class="desc">Comparació de l’estat d’ànim entre gèneres (mitjana de valence). Ordenat de més “optimista” a menys.</div>
        <div id="plot_genres" class="plot"></div>
      </div>

      <div class="card">
        <h2>3) Popularitat vs característica</h2>
        <div class="desc">Explora si una característica sonora s’associa a més popularitat (tendències i dispersió).</div>
        <div id="plot_popularity" class="plot"></div>
      </div>

      <div class="card">
        <h2>4) Correlacions (heatmap)</h2>
        <div class="desc">Relacions entre característiques sonores i popularitat (correlació de Pearson sobre la mostra filtrada).</div>
        <div id="plot_corr" class="plot"></div>
      </div>
    </div>
  </main>

  <script>
    const CSV_PATH = "data/spotify.csv";

    // Estat
    let raw = [];
    let genresAll = [];

    // Elements UI
    const genreSelect = document.getElementById("genreSelect");
    const popSlider = document.getElementById("popSlider");
    const popVal = document.getElementById("popVal");
    const topGenresInput = document.getElementById("topGenres");
    const featureSelect = document.getElementById("featureSelect");

    // Helpers
    function num(x) {
      const v = Number(x);
      return Number.isFinite(v) ? v : null;
    }
    function text(x) { return (x ?? "").toString().trim(); }

    // Calculs
    function emotionalityIndex(r){
      const v = num(r.valence), e = num(r.energy);
      return (v === null || e === null) ? null : v * e;
    }

    function buildGenreList(rows) {
      const set = new Set();
      rows.forEach(r => {
        const g = text(r.track_genre);
        if (g) set.add(g);
      });
      return Array.from(set).sort((a,b)=>a.localeCompare(b));
    }

    // Filtratge global (gènere + popularitat mínima)
    function filterRowsGlobal() {
      const g = genreSelect.value;
      const minPop = Number(popSlider.value);

      return raw.filter(r => {
        const valence = num(r.valence);
        const energy  = num(r.energy);
        const popularity = num(r.popularity);

        if (valence === null || energy === null || popularity === null) return false;
        if (popularity < minPop) return false;
        if (g !== "__ALL__" && text(r.track_genre) !== g) return false;
        return true;
      });
    }

    // Top N gèneres (per AVG(popularity)) en la mostra global filtrada només per popularitat (no per gènere selec.)
    function computeTopGenresByPopularity(rows, topN){
      const agg = new Map(); // genre -> {sum, n}
      rows.forEach(r=>{
        const g = text(r.track_genre);
        const p = num(r.popularity);
        if (!g || p===null) return;
        if (!agg.has(g)) agg.set(g, {sum:0, n:0});
        const o = agg.get(g);
        o.sum += p; o.n += 1;
      });
      const arr = Array.from(agg.entries()).map(([g,o])=>({g, avg: o.sum/o.n, n:o.n}));
      arr.sort((a,b)=> b.avg - a.avg);
      return arr.slice(0, topN).map(d=>d.g);
    }

    // 1) Scatter Mapa emocional
    function renderEmotionalMap(rows, allowedGenres) {
      const f = rows.filter(r => allowedGenres.has(text(r.track_genre)));

      const x = f.map(r => num(r.valence));
      const y = f.map(r => num(r.energy));
      const popularity = f.map(r => num(r.popularity));
      const size = popularity.map(p => Math.max(4, (p ?? 0) / 5)); // menys “massa negra”
      const color = f.map(r => text(r.track_genre));

      const hover = f.map(r => {
        const t = text(r.track_name);
        const a = text(r.artists);
        const g = text(r.track_genre) || "NA";
        const p = num(r.popularity);
        const v = num(r.valence);
        const e = num(r.energy);
        const emo = emotionalityIndex(r);
        return `<b>${t || "(sense títol)"}</b><br>` +
               `${a || "(sense artista)"}<br>` +
               `Gènere: ${g}<br>` +
               `Popularitat: ${p}<br>` +
               `Valence: ${v}<br>` +
               `Energy: ${e}<br>` +
               `Índex emocional (v·e): ${emo===null ? "NA" : emo.toFixed(3)}`;
      });

      const trace = {
        type: "scattergl",
        mode: "markers",
        x, y,
        text: hover,
        hoverinfo: "text",
        marker: {
          size,
          opacity: 0.35,
          color
        }
      };

      const layout = {
        margin: { l: 55, r: 20, t: 10, b: 50 },
        xaxis: { title: "Valence (positivitat)", range: [0, 1] },
        yaxis: { title: "Energy (intensitat)", range: [0, 1] },
        legend: { title: { text: "Gènere" } }
      };

      Plotly.newPlot("plot_emotional", [trace], layout, { responsive: true, displayModeBar: false });
    }

    // 2) Barres Valence per gènere (Top N)
    function renderValenceByGenre(rows, topGenres) {
      const agg = new Map(); // genre -> {sumValence, n}
      rows.forEach(r=>{
        const g = text(r.track_genre);
        const v = num(r.valence);
        if (!g || v===null) return;
        if (!topGenres.has(g)) return;
        if (!agg.has(g)) agg.set(g, {sum:0, n:0});
        const o = agg.get(g);
        o.sum += v; o.n += 1;
      });

      const arr = Array.from(agg.entries()).map(([g,o])=>({g, mean: o.sum/o.n, n:o.n}));
      arr.sort((a,b)=> b.mean - a.mean);

      const x = arr.map(d=>d.g);
      const y = arr.map(d=>d.mean);
      const hover = arr.map(d=> `Gènere: ${d.g}<br>Valence mitjana: ${d.mean.toFixed(3)}<br>N: ${d.n}`);

      const trace = {
        type: "bar",
        x, y,
        text: hover,
        hoverinfo: "text"
      };

      const layout = {
        margin: { l: 55, r: 20, t: 10, b: 120 },
        yaxis: { title: "Valence mitjana", range: [0, 1] },
        xaxis: { tickangle: -45 }
      };

      Plotly.newPlot("plot_genres", [trace], layout, { responsive: true, displayModeBar: false });
    }

    // 3) Popularitat vs característica (scatter)
    function renderPopularityVsFeature(rows, allowedGenres, feature) {
      const f = rows.filter(r => allowedGenres.has(text(r.track_genre)));

      const x = f.map(r => num(r[feature]));
      const y = f.map(r => num(r.popularity));
      const color = f.map(r => text(r.track_genre));
      const hover = f.map(r => {
        const t = text(r.track_name);
        const a = text(r.artists);
        const g = text(r.track_genre) || "NA";
        const p = num(r.popularity);
        const fx = num(r[feature]);
        return `<b>${t || "(sense títol)"}</b><br>` +
               `${a || "(sense artista)"}<br>` +
               `Gènere: ${g}<br>` +
               `Popularitat: ${p}<br>` +
               `${feature}: ${fx}`;
      });

      const trace = {
        type: "scattergl",
        mode: "markers",
        x, y,
        text: hover,
        hoverinfo: "text",
        marker: { opacity: 0.35, size: 6, color }
      };

      const layout = {
        margin: { l: 55, r: 20, t: 10, b: 55 },
        xaxis: { title: `${feature}` },
        yaxis: { title: "Popularitat (0–100)", range: [0, 100] },
        legend: { title: { text: "Gènere" } }
      };

      Plotly.newPlot("plot_popularity", [trace], layout, { responsive: true, displayModeBar: false });
    }

    // 4) Correlacions: Pearson sobre la mostra filtrada
    function pearson(x, y){
      // ignora nulls
      let n=0, sx=0, sy=0, sxx=0, syy=0, sxy=0;
      for (let i=0;i<x.length;i++){
        const a=x[i], b=y[i];
        if (a===null || b===null) continue;
        n++; sx+=a; sy+=b; sxx+=a*a; syy+=b*b; sxy+=a*b;
      }
      if (n < 3) return null;
      const cov = sxy/n - (sx/n)*(sy/n);
      const vx  = sxx/n - (sx/n)*(sx/n);
      const vy  = syy/n - (sy/n)*(sy/n);
      if (vx <= 0 || vy <= 0) return null;
      return cov / Math.sqrt(vx*vy);
    }

    function renderCorrelationHeatmap(rows, allowedGenres){
      const f = rows.filter(r => allowedGenres.has(text(r.track_genre)));

      const vars = ["popularity","danceability","energy","valence","tempo","acousticness","speechiness","instrumentalness","liveness"];
      const series = {};
      vars.forEach(v=>{
        series[v] = f.map(r => num(r[v]));
      });

      const z = [];
      for (let i=0;i<vars.length;i++){
        const row = [];
        for (let j=0;j<vars.length;j++){
          const r = pearson(series[vars[i]], series[vars[j]]);
          row.push(r === null ? null : Number(r.toFixed(2)));
        }
        z.push(row);
      }

      const trace = {
        type: "heatmap",
        x: vars,
        y: vars,
        z: z,
        hovertemplate: "X: %{x}<br>Y: %{y}<br>r: %{z}<extra></extra>"
      };

      const layout = {
        margin: { l: 110, r: 20, t: 10, b: 70 },
        xaxis: { tickangle: -45 },
        yaxis: { autorange: "reversed" }
      };

      Plotly.newPlot("plot_corr", [trace], layout, { responsive: true, displayModeBar: false });
    }

    // Render global
    function renderAll(){
      popVal.textContent = popSlider.value;

      // Mostra base filtrada només per popularitat (i gènere si està seleccionat)
      const rowsGlobal = filterRowsGlobal();

      // Per evitar massa “soroll”, definim un set de gèneres permesos (Top N per popularitat)
      const topN = Math.max(5, Math.min(50, Number(topGenresInput.value || 15)));
      const topGenres = computeTopGenresByPopularity(rowsGlobal, topN);
      const allowedGenres = new Set(topGenres);

      // Si l’usuari selecciona un gènere concret, el set serà només aquest (sempre que existeixi)
      if (genreSelect.value !== "__ALL__") {
        allowedGenres.clear();
        allowedGenres.add(genreSelect.value);
      }

      // Render vistes
      renderEmotionalMap(rowsGlobal, allowedGenres);
      renderValenceByGenre(rowsGlobal, allowedGenres);
      renderPopularityVsFeature(rowsGlobal, allowedGenres, featureSelect.value);
      renderCorrelationHeatmap(rowsGlobal, allowedGenres);
    }

    function initControls(){
      // Dropdown de gèneres
      genresAll.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        genreSelect.appendChild(opt);
      });

      // Listeners
      genreSelect.addEventListener("change", renderAll);
      popSlider.addEventListener("input", renderAll);
      topGenresInput.addEventListener("change", renderAll);
      featureSelect.addEventListener("change", renderAll);
    }

    // Carrega CSV
    Papa.parse(CSV_PATH, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        raw = results.data;
        genresAll = buildGenreList(raw);
        initControls();
        renderAll();
      },
      error: (err) => {
        console.error(err);
        alert("Error carregant el CSV. Revisa que existeix: " + CSV_PATH);
      }
    });
  </script>
</body>
</html>
